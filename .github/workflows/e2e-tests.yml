name: E2E Containerized Tests

# End-to-end tests that build Docker image and run tests against containerized API
#
# Required Secrets:
#   - INTEGRATION_TEST_GITHUB_APP_ID: GitHub App ID for authentication
#   - INTEGRATION_TEST_GITHUB_APP_PRIVATE_KEY: GitHub App private key (PEM format)
#   - INTEGRATION_TEST_ORG: Test organization name
#
# Configuration:
#   - METADATA_REPOSITORY_NAME: ".reporoller-test" (test metadata repository)
#   - TEST_TEMPLATE: "template-test-basic" (basic test template - must exist in metadata repo)
#
# Note: The test_e2e_create_repository_with_global_defaults test will fail if
# TEST_TEMPLATE references a non-existent template. To set up the template:
#   1. Create templates/template-test-basic/ directory in metadata repository
#   2. Add template.toml with basic configuration
#   3. Add README.md with template description

on:
  pull_request:
    branches: [master]
    paths:
      - "crates/**"
      - "!crates/integration_tests/**"
      - ".github/workflows/e2e-tests.yml"

  # Allow manual triggering
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  e2e-tests:
    name: E2E Container Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0 # v2
        with:
          key: e2e-tests
          cache-on-failure: true

      - name: Verify Docker is available
        run: |
          echo "Checking Docker daemon..."
          docker info
          echo "‚úì Docker is available"

      - name: Build Docker image
        run: |
          echo "üê≥ Building repo_roller_api Docker image..."
          docker build -t repo_roller_api:test -f crates/repo_roller_api/Dockerfile .
          echo "‚úì Docker image built successfully"

      - name: Verify Docker image
        run: |
          echo "Verifying Docker image..."
          docker images | grep repo_roller_api
          echo "‚úì Image verified"

      - name: Validate environment setup
        env:
          GITHUB_APP_ID: ${{ secrets.INTEGRATION_TEST_GITHUB_APP_ID }}
          GITHUB_APP_PRIVATE_KEY: ${{ secrets.INTEGRATION_TEST_GITHUB_APP_PRIVATE_KEY }}
          TEST_ORG: ${{ secrets.INTEGRATION_TEST_ORG }}
        run: |
          echo "Validating E2E test environment..."

          if [ -z "$GITHUB_APP_ID" ]; then
            echo "‚ùå INTEGRATION_TEST_GITHUB_APP_ID secret not set"
            exit 1
          fi

          if [ -z "$GITHUB_APP_PRIVATE_KEY" ]; then
            echo "‚ùå INTEGRATION_TEST_GITHUB_APP_PRIVATE_KEY secret not set"
            exit 1
          fi

          if [ -z "$TEST_ORG" ]; then
            echo "‚ùå INTEGRATION_TEST_ORG secret not set"
            exit 1
          fi

          echo "‚úÖ All required secrets are configured"
          echo "üìã GitHub App ID: $GITHUB_APP_ID"
          echo "üìã Test Organization: $TEST_ORG"
          echo "üìã Metadata Repository: $METADATA_REPOSITORY_NAME"
          echo ""
          echo "‚ö†Ô∏è  IMPORTANT: The metadata repository must exist in the test organization!"
          echo "   Expected location: $TEST_ORG/.reporoller-test"
          echo "   If tests fail with 404/500 errors, verify:"
          echo "   1. Repository exists: https://github.com/$TEST_ORG/.reporoller-test"
          echo "   2. GitHub App has access to the repository"

      - name: Run E2E containerized tests
        env:
          GITHUB_APP_ID: ${{ secrets.INTEGRATION_TEST_GITHUB_APP_ID }}
          GITHUB_APP_PRIVATE_KEY: ${{ secrets.INTEGRATION_TEST_GITHUB_APP_PRIVATE_KEY }}
          TEST_ORG: ${{ secrets.INTEGRATION_TEST_ORG }}
          METADATA_REPOSITORY_NAME: ".reporoller-test"
          TEST_TEMPLATE: "template-test-basic"
          RUST_LOG: info
        run: |
          echo "üöÄ Running E2E containerized tests..."
          echo "‚ö† Tests run sequentially to avoid port conflicts"

          # Run E2E tests with single thread to avoid port conflicts
          cargo test \
            --package e2e_tests \
            -- --test-threads=1 \
            --nocapture

      - name: Cleanup Docker resources
        if: always()
        run: |
          echo "üßπ Cleaning up Docker resources..."

          # Stop and remove test containers
          docker ps -a | grep repo_roller_api_test | awk '{print $1}' | xargs -r docker rm -f

          # Remove test images
          docker images | grep repo_roller_api | grep test | awk '{print $3}' | xargs -r docker rmi -f

          echo "‚úì Docker cleanup complete"

      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: e2e-test-logs
          path: |
            *.log
            target/debug/deps/e2e_containerized-*.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Comment on PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const success = '${{ job.status }}' === 'success';
            const statusEmoji = success ? '‚úÖ' : '‚ùå';
            const statusText = success ? 'PASSED' : 'FAILED';

            const commentBody = `
            ## ${statusEmoji} E2E Containerized Tests ${statusText}

            **Workflow**: \`${{ github.workflow }}\`
            **Run ID**: [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **Commit**: \`${{ github.sha }}\`

            ${success ?
              'üéâ All E2E containerized tests passed! The API works correctly in Docker container.' :
              '‚ö†Ô∏è E2E containerized tests failed. Please review the logs and fix any issues.'
            }

            ### What was tested:
            - ‚úì Docker image build
            - ‚úì Container startup and health check
            - ‚úì HTTP endpoints via external client
            - ‚úì Complete request/response cycle
            - ‚úì Production deployment environment
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
