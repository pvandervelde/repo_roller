name: Cleanup Test Repositories

on:
    schedule:
        # Run daily at 2 AM UTC - catches any repos missed by PR cleanup
        - cron: "0 2 * * *"
    workflow_dispatch:
        inputs:
            max_age_hours:
                description: "Maximum age in hours for test repositories to keep"
                required: false
                default: "24"
                type: string

permissions:
    contents: read
    issues: write  # For creating issues on cleanup failures

jobs:
    cleanup:
        name: Clean up orphaned test repositories
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Cache Rust dependencies
              uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0 # v2
              with:
                  key: cleanup-tests
                  cache-on-failure: true

            - name: Validate environment setup
              env:
                  GITHUB_APP_ID: ${{ secrets.INTEGRATION_TEST_GITHUB_APP_ID }}
                  GITHUB_APP_PRIVATE_KEY: ${{ secrets.INTEGRATION_TEST_GITHUB_APP_PRIVATE_KEY }}
                  TEST_ORG: ${{ secrets.INTEGRATION_TEST_ORG }}
              run: |
                  echo "üîç Validating environment..."
                  if [ -z "$GITHUB_APP_ID" ]; then
                    echo "‚ùå INTEGRATION_TEST_GITHUB_APP_ID secret not set"
                    exit 1
                  fi
                  if [ -z "$GITHUB_APP_PRIVATE_KEY" ]; then
                    echo "‚ùå INTEGRATION_TEST_GITHUB_APP_PRIVATE_KEY secret not set"
                    exit 1
                  fi
                  if [ -z "$TEST_ORG" ]; then
                    echo "‚ùå INTEGRATION_TEST_ORG secret not set"
                    exit 1
                  fi
                  echo "‚úÖ All required secrets configured"
                  echo "üìã Test Organization: $TEST_ORG"

            - name: Run scheduled cleanup (safety net)
              if: github.event_name == 'schedule'
              id: scheduled_cleanup
              env:
                  GITHUB_APP_ID: ${{ secrets.INTEGRATION_TEST_GITHUB_APP_ID }}
                  GITHUB_APP_PRIVATE_KEY: ${{ secrets.INTEGRATION_TEST_GITHUB_APP_PRIVATE_KEY }}
                  TEST_ORG: ${{ secrets.INTEGRATION_TEST_ORG }}
                  RUST_LOG: info
              run: |
                  echo "üßπ Running scheduled cleanup (safety net for missed PRs)"
                  echo "   Max age: 24 hours"
                  echo "   This catches test repos that weren't cleaned up by PR workflows"
                  echo ""
                  
                  # Run cleanup and capture output
                  output=$(cargo run --package test_cleanup --bin cleanup-orphans -- 24 2>&1)
                  echo "$output"
                  
                  # Extract deleted count for summary
                  deleted_count=$(echo "$output" | grep "Deleted.*repositories" | grep -oE '[0-9]+' || echo "0")
                  echo "deleted_count=$deleted_count" >> $GITHUB_OUTPUT
                  
                  # Save output for potential issue creation
                  echo "cleanup_output<<EOF" >> $GITHUB_OUTPUT
                  echo "$output" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Run manual cleanup
              if: github.event_name == 'workflow_dispatch'
              id: manual_cleanup
              env:
                  GITHUB_APP_ID: ${{ secrets.INTEGRATION_TEST_GITHUB_APP_ID }}
                  GITHUB_APP_PRIVATE_KEY: ${{ secrets.INTEGRATION_TEST_GITHUB_APP_PRIVATE_KEY }}
                  TEST_ORG: ${{ secrets.INTEGRATION_TEST_ORG }}
                  RUST_LOG: info
              run: |
                  MAX_AGE="${{ inputs.max_age_hours }}"
                  
                  echo "üßπ Running manual cleanup"
                  echo "   Max age: $MAX_AGE hours"
                  echo ""
                  
                  # Run cleanup and capture output
                  output=$(cargo run --package test_cleanup --bin cleanup-orphans -- "$MAX_AGE" 2>&1)
                  echo "$output"
                  
                  # Extract deleted count
                  deleted_count=$(echo "$output" | grep "Deleted.*repositories" | grep -oE '[0-9]+' || echo "0")
                  echo "deleted_count=$deleted_count" >> $GITHUB_OUTPUT

            - name: Create summary
              if: always() && (steps.scheduled_cleanup.outcome != 'skipped' || steps.manual_cleanup.outcome != 'skipped')
              run: |
                  echo "## üßπ Test Repository Cleanup Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  
                  if [ "${{ github.event_name }}" == "schedule" ]; then
                    deleted="${{ steps.scheduled_cleanup.outputs.deleted_count }}"
                    echo "**Type**: Scheduled (Safety Net)" >> $GITHUB_STEP_SUMMARY
                    echo "**Max Age**: 24 hours" >> $GITHUB_STEP_SUMMARY
                  else
                    deleted="${{ steps.manual_cleanup.outputs.deleted_count }}"
                    echo "**Type**: Manual" >> $GITHUB_STEP_SUMMARY
                    echo "**Max Age**: ${{ inputs.max_age_hours }} hours" >> $GITHUB_STEP_SUMMARY
                  fi
                  
                  echo "**Repositories Deleted**: $deleted" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  
                  if [ "$deleted" == "0" ]; then
                    echo "‚úÖ No orphaned repositories found - cleanup is working well!" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "üßπ Cleaned up $deleted orphaned test repositories" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "> These repositories were likely from PRs that failed to clean up" >> $GITHUB_STEP_SUMMARY
                    echo "> or from test runs that didn't complete. This is the safety net working as intended." >> $GITHUB_STEP_SUMMARY
                  fi

            - name: Alert on high orphan count
              if: always() && steps.scheduled_cleanup.outputs.deleted_count > 10
              uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
              with:
                  script: |
                      const deletedCount = ${{ steps.scheduled_cleanup.outputs.deleted_count }};
                      
                      // Create an issue to alert about high orphan count
                      await github.rest.issues.create({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          title: `‚ö†Ô∏è High orphaned test repository count: ${deletedCount} repos cleaned`,
                          body: `## Orphaned Test Repository Alert\n\n` +
                              `The scheduled cleanup job found and deleted **${deletedCount}** orphaned test repositories.\n\n` +
                              `This is unusually high and may indicate:\n` +
                              `- PR cleanup workflow is failing\n` +
                              `- Tests are crashing before cleanup can run\n` +
                              `- Repository naming conventions have changed\n\n` +
                              `### Action Required\n\n` +
                              `1. Review recent PR cleanup workflow runs\n` +
                              `2. Check test failure logs\n` +
                              `3. Verify repository naming is correct\n\n` +
                              `See the [cleanup workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.\n\n` +
                              `*This issue was automatically created by the scheduled cleanup safety net.*`,
                          labels: ['infrastructure', 'automated']
                      });
