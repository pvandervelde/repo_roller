name: Cleanup Test Repositories

on:
    schedule:
        # Run daily at 2 AM UTC
        - cron: "0 2 * * *"
    workflow_dispatch:
        inputs:
            max_age_hours:
                description: "Maximum age in hours for test repositories to keep"
                required: false
                default: "1"
                type: string
            dry_run:
                description: "Dry run mode (only list repos, do not delete)"
                required: false
                default: false
                type: boolean

permissions:
    contents: read

jobs:
    cleanup:
        name: Clean up orphaned test repositories
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Cache Rust dependencies
              uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0 # v2
              with:
                  key: cleanup-tests
                  cache-on-failure: true

            - name: Validate environment setup
              env:
                  GITHUB_APP_ID: ${{ secrets.INTEGRATION_TEST_GITHUB_APP_ID }}
                  GITHUB_APP_PRIVATE_KEY: ${{ secrets.INTEGRATION_TEST_GITHUB_APP_PRIVATE_KEY }}
                  TEST_ORG: ${{ secrets.INTEGRATION_TEST_ORG }}
              run: |
                  echo "Validating environment..."
                  if [ -z "$GITHUB_APP_ID" ]; then
                    echo "‚ùå INTEGRATION_TEST_GITHUB_APP_ID secret not set"
                    exit 1
                  fi
                  if [ -z "$GITHUB_APP_PRIVATE_KEY" ]; then
                    echo "‚ùå INTEGRATION_TEST_GITHUB_APP_PRIVATE_KEY secret not set"
                    exit 1
                  fi
                  if [ -z "$TEST_ORG" ]; then
                    echo "‚ùå INTEGRATION_TEST_ORG secret not set"
                    exit 1
                  fi
                  echo "‚úÖ All required secrets configured"
                  echo "üìã Test Organization: $TEST_ORG"

            - name: Run cleanup (scheduled)
              if: github.event_name == 'schedule'
              env:
                  GITHUB_APP_ID: ${{ secrets.INTEGRATION_TEST_GITHUB_APP_ID }}
                  GITHUB_APP_PRIVATE_KEY: ${{ secrets.INTEGRATION_TEST_GITHUB_APP_PRIVATE_KEY }}
                  TEST_ORG: ${{ secrets.INTEGRATION_TEST_ORG }}
                  RUST_LOG: info
              run: |
                  echo "üßπ Running scheduled cleanup (max age: 1 hour)..."
                  cargo run --package integration_tests --example cleanup_orphans -- 1

            - name: Run cleanup (manual)
              if: github.event_name == 'workflow_dispatch'
              env:
                  GITHUB_APP_ID: ${{ secrets.INTEGRATION_TEST_GITHUB_APP_ID }}
                  GITHUB_APP_PRIVATE_KEY: ${{ secrets.INTEGRATION_TEST_GITHUB_APP_PRIVATE_KEY }}
                  TEST_ORG: ${{ secrets.INTEGRATION_TEST_ORG }}
                  RUST_LOG: info
              run: |
                  MAX_AGE="${{ inputs.max_age_hours }}"
                  DRY_RUN="${{ inputs.dry_run }}"

                  if [ "$DRY_RUN" == "true" ]; then
                    echo "‚ö†Ô∏è  Dry run mode not supported in Rust cleanup utility"
                    echo "   Run without dry_run flag to perform actual cleanup"
                    exit 1
                  fi

                  echo "üßπ Running manual cleanup (max age: $MAX_AGE hours)..."
                  cargo run --package integration_tests --example cleanup_orphans -- "$MAX_AGE"

            - name: Report cleanup results
              if: always()
              run: |
                  echo "Cleanup workflow completed"
                  echo "Check logs above for details on deleted repositories"
